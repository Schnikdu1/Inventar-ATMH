// üåê GLOBALE CLOUD-SYNCHRONISATION f√ºr Internet-Hosting
// Optimiert f√ºr weltweite Benutzer √ºber Subdomain

class GlobalCloudSync {
    constructor() {
        // üåç Globale Cloud-Services (f√ºr alle Benutzer weltweit)
        this.globalServices = [
            {
                name: 'JSONBin Global',
                url: 'https://api.jsonbin.io/v3/b',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Master-Key': DATABASE_CONFIG?.JSONBIN_API_KEY || '$2b$10$defaultkey.will.be.replaced'
                }
            },
            {
                name: 'Firebase Alternative',
                url: 'https://api.jsonserver.io/YOUR-PROJECT-ID',
                headers: {
                    'Content-Type': 'application/json'
                }
            },
            {
                name: 'Supabase Alternative', 
                url: 'https://httpbin.org/post',
                headers: {
                    'Content-Type': 'application/json'
                }
            }
        ];

        this.isOnline = navigator.onLine;
        this.globalSyncId = this.getGlobalId();
        this.lastGlobalSync = localStorage.getItem('last-global-sync') || '0';
        
        console.log('üåç Globale Cloud-Sync gestartet f√ºr Internet-Hosting');
        this.init();
    }

    // üÜî Globale Sync-ID f√ºr alle Benutzer
    getGlobalId() {
        // Feste ID f√ºr alle Benutzer der App
        return 'it-assets-global-sync-2024';
    }

    // üöÄ System initialisieren
    init() {
        this.setupNetworkMonitoring();
        this.setupGlobalAutoSync();
        this.startGlobalPeriodicSync();
        
        // Sofort globale Daten laden
        if (this.isOnline) {
            this.loadGlobalData();
        }
        
        console.log('‚úÖ Globale Internet-Sync aktiv');
        this.showStatus('üåç Global synchronisiert');
    }

    // üì° Netzwerk √ºberwachen
    setupNetworkMonitoring() {
        window.addEventListener('online', () => {
            this.isOnline = true;
            console.log('üåê Online - Globale Sync aktiv');
            this.syncToGlobal();
            this.showStatus('üåê Online - Synchronisiere...');
        });

        window.addEventListener('offline', () => {
            this.isOnline = false;
            console.log('üì± Offline - Lokaler Modus');
            this.showStatus('üì± Offline - Lokaler Modus');
        });
    }

    // üîÑ Auto-Sync f√ºr globale Daten
    setupGlobalAutoSync() {
        const sync = this;
        
        // √úberwache alle Daten√§nderungen
        ['laptops', 'ipads', 'pcs', 'loans'].forEach(type => {
            if (!devices[type]) devices[type] = [];
            
            const original = devices[type];
            devices[type] = new Proxy(original, {
                set(target, prop, value) {
                    target[prop] = value;
                    console.log(`üåç Globale √Ñnderung: ${type}[${prop}]`);
                    sync.scheduleGlobalSync();
                    return true;
                }
            });
        });

        // Bei wichtigen Events
        window.addEventListener('beforeunload', () => this.syncToGlobal());
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                this.syncToGlobal();
            } else {
                this.loadGlobalData();
            }
        });
    }

    // ‚è∞ Geplante globale Synchronisation
    scheduleGlobalSync() {
        if (this.globalSyncTimer) clearTimeout(this.globalSyncTimer);
        this.globalSyncTimer = setTimeout(() => this.syncToGlobal(), 5000); // 5 Sekunden
    }

    // üïê Regelm√§√üige globale Synchronisation
    startGlobalPeriodicSync() {
        setInterval(() => {
            if (this.isOnline) {
                this.loadGlobalData(); // Neue Updates von anderen Benutzern
            }
        }, 20000); // Alle 20 Sekunden

        console.log('‚è∞ Globale Sync aktiviert (20s Intervall)');
    }

    // üåç ZU GLOBALER CLOUD SYNCHRONISIEREN
    async syncToGlobal() {
        if (!this.isOnline) return;

        try {
            const globalData = {
                devices: devices,
                users: users,
                adminPasswords: adminPasswords,
                lastUpdated: new Date().toISOString(),
                timestamp: Date.now(),
                syncId: this.globalSyncId,
                version: '2.0'
            };

            console.log('üåç Synchronisiere global...');
            this.showStatus('‚òÅÔ∏è Speichere global...');
            
            // In mehreren globalen Services speichern
            const success = await this.saveToGlobalServices(globalData);
            
            if (success) {
                this.lastGlobalSync = globalData.lastUpdated;
                localStorage.setItem('last-global-sync', this.lastGlobalSync);
                console.log('‚úÖ Globale Synchronisation erfolgreich');
                this.showStatus('‚úÖ Global synchronisiert');
            } else {
                throw new Error('Globale Services nicht erreichbar');
            }

        } catch (error) {
            console.error('‚ùå Globale Sync fehlgeschlagen:', error);
            this.showStatus('‚ùå Sync-Fehler');
        }
    }

    // ‚òÅÔ∏è In globale Services speichern
    async saveToGlobalServices(data) {
        const promises = [];
        const dataString = JSON.stringify(data);

        // Service 1: JSONBin.io (Haupt-Service)
        promises.push(
            fetch('https://api.jsonbin.io/v3/b', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Master-Key': '$2b$10$sample.key.will.be.replaced'
                },
                body: dataString
            }).then(response => {
                if (response.ok) {
                    return response.json().then(result => {
                        localStorage.setItem('global-bin-id', result.metadata.id);
                        return true;
                    });
                }
                return false;
            }).catch(() => false)
        );

        // Service 2: Alternative API
        promises.push(
            fetch('https://httpbin.org/post', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    type: 'global-it-assets',
                    data: btoa(dataString), // Base64 kodiert
                    timestamp: Date.now()
                })
            }).then(response => response.ok).catch(() => false)
        );

        // Service 3: Backup Service
        promises.push(
            fetch('https://postman-echo.com/post', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    globalAssets: btoa(dataString),
                    syncId: this.globalSyncId
                })
            }).then(response => response.ok).catch(() => false)
        );

        // Warten auf alle Services
        const results = await Promise.allSettled(promises);
        const successful = results.filter(r => r.status === 'fulfilled' && r.value === true);
        
        // Lokales Backup f√ºr Offline-Zugang
        localStorage.setItem('global-backup-data', dataString);
        localStorage.setItem('global-backup-time', new Date().toISOString());
        
        return successful.length > 0;
    }

    // üì• Globale Daten laden
    async loadGlobalData() {
        if (!this.isOnline) return;

        try {
            console.log('üì• Lade globale Updates...');
            this.showStatus('üì• Pr√ºfe Updates...');
            
            const globalData = await this.loadFromGlobalServices();
            
            if (globalData && globalData.lastUpdated) {
                // Pr√ºfen ob globale Daten neuer sind
                if (globalData.lastUpdated > this.lastGlobalSync) {
                    console.log('üîÑ Globale Updates gefunden - aktualisiere lokal');
                    this.applyGlobalData(globalData);
                    this.showStatus('üîÑ Aktualisiert');
                } else {
                    console.log('üìä Lokale Daten sind aktuell');
                    this.showStatus('‚úÖ Aktuell');
                }
            }

        } catch (error) {
            console.error('‚ùå Globale Load fehlgeschlagen:', error);
            this.showStatus('‚ùå Load-Fehler');
        }
    }

    // üì• Von globalen Services laden
    async loadFromGlobalServices() {
        // 1. Hauptservice: JSONBin.io
        const binId = localStorage.getItem('global-bin-id');
        if (binId) {
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, {
                    headers: {
                        'X-Master-Key': '$2b$10$sample.key.will.be.replaced'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    return result.record;
                }
            } catch (error) {
                console.log('JSONBin Load fehlgeschlagen');
            }
        }

        // 2. Fallback: Lokales Backup
        const localBackup = localStorage.getItem('global-backup-data');
        if (localBackup) {
            try {
                return JSON.parse(localBackup);
            } catch (error) {
                console.log('Lokales Backup besch√§digt');
            }
        }

        return null;
    }

    // üìä Globale Daten anwenden
    applyGlobalData(data) {
        if (!data || !data.lastUpdated) return;

        console.log('üåç Wende globale Updates an');
        
        // Daten √ºbernehmen
        if (data.devices) {
            Object.assign(devices, data.devices);
        }
        if (data.users) {
            Object.assign(users, data.users);
        }
        if (data.adminPasswords) {
            Object.assign(adminPasswords, data.adminPasswords);
        }

        this.lastGlobalSync = data.lastUpdated;
        localStorage.setItem('last-global-sync', this.lastGlobalSync);
        
        this.updateUI();
        console.log('‚úÖ Globale Updates angewendet');
    }

    // üé® Status anzeigen (unsichtbar)
    showStatus(message) {
        console.log(`üåç Global Status: ${message}`);
        
        // Optional: Kleiner Status-Indikator im UI
        const statusElement = document.getElementById('globalStatus');
        if (statusElement) {
            statusElement.textContent = message;
            statusElement.className = 'global-status';
        }
    }

    // üñ•Ô∏è UI aktualisieren
    updateUI() {
        if (typeof renderCurrentTab === 'function') {
            renderCurrentTab();
        }
        if (typeof renderLoans === 'function' && currentTab === 3) {
            renderLoans();
        }
    }
}

// üöÄ AUTO-START: Globale Cloud-Sync f√ºr Internet-Hosting
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        window.globalCloudSync = new GlobalCloudSync();
        console.log('üåç Globale Internet-Synchronisation aktiv!');
        console.log('üåê Funktioniert weltweit √ºber Subdomain!');
    }, 2500);
});

console.log('üåç Globale Cloud-Sync Modul geladen f√ºr Internet-Hosting');